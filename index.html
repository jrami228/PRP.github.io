<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Records Search Portal</title>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Apply Inter font globally and set dark theme defaults */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for inputs */
        input::placeholder {
            color: #9ca3af; /* Gray-400 */
            opacity: 0.8;
        }

        /* Remove arrows/spinners from number inputs */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Fade-in animation for dynamic buttons */
        .facid-entry {
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4">

    <!-- Search Form View -->
    <div id="search-form-view" class="w-full max-w-xl mx-auto flex flex-col items-center justify-center min-h-screen py-8">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl flex flex-col items-center w-full">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-8 text-yellow-400">
                Public Records Search
            </h1>
            
            <div class="space-y-8 w-full max-md">

                <!-- 1. Case Number Search Section (ECM/CARA) -->
                <div class="space-y-4 border-b border-gray-700 pb-8">
                    <h2 class="text-xl font-bold text-blue-400 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-9 0V3h4m-4 2h4m-2 2h2m-6 0v2m0 4v2m0 4v2m4-10h2m0 4h2m0 4h2" />
                        </svg>
                        Search DERM/RER Records

                        <div class="relative group ml-2 cursor-help">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-300 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 text-white text-xs font-normal rounded-lg shadow-xl border border-gray-600 hidden group-hover:block z-50 text-center leading-relaxed">
                                Use this option to search the DERM/RER Public Records at https://ecmrer.miamidade.gov/
                            </div>
                        </div>
                    </h2>
                    
                    <div class="flex flex-col">
                        <label for="workgroup" class="text-gray-400 text-sm mb-2">Work Group </label>
                        <select id="workgroup" class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                            <option value="UT" selected>UT</option>
                            <option value="HWR">HWR</option>
                            <option value="IW5">IW5</option>
                            <option value="IW6">IW6</option>
                        </select>
                    </div>

                    <div class="flex flex-col">
                        <label for="case-number" class="text-gray-400 text-sm mb-2">Work Group Number</label>
                        <input type="number" id="case-number" placeholder="e.g., 557 (no leading zeros)" 
                               class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-center">
                    </div>

                    <button id="case-search-button" disabled 
                                 class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-bold shadow-lg 
                                       hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 
                                       focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 
                                       disabled:opacity-50 disabled:cursor-not-allowed"> 
                        Search ECM/CARA
                    </button>

                    <!-- Live FACID Buttons Area -->
                    <div id="live-facid-container" class="space-y-4 mt-4"></div>
                </div>

                <!-- 2. FDEP Information Portal -->
                <div class="space-y-4 border-b border-gray-700 pb-8">
                    <h2 class="text-xl font-bold text-green-400 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Search FDEP Information Portal
                        <div class="relative group ml-2 cursor-help">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-300 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 text-white text-xs font-normal rounded-lg shadow-xl border border-gray-600 hidden group-hover:block z-50 text-center leading-relaxed">
                                Use this option to search the FDEP Information Portal for an FDEP FACID or for an FDEP ERIC ID at https://prodenv.dep.state.fl.us/DepNexus/
                            </div>
                        </div>
                    </h2>

                    <div class="flex flex-col">
                        <label for="facid-input" class="text-gray-400 text-sm mb-2">FDEP Facility ID</label>
                        <input type="tel" id="facid-input" inputmode="numeric" placeholder="Enter FACID, e.g., 138505326 or 8505326" 
                               class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200 text-center">
                    </div>

                    <button id="facid-search-button" disabled 
                                 class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-bold shadow-lg 
                                       hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 
                                       focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 
                                       disabled:opacity-50 disabled:cursor-not-allowed"> 
                        Search by FACID
                    </button>

                    <!-- FACID to Workgroup Reverse Lookup Container -->
                    <div id="facid-to-wg-container" class="space-y-4 mt-4"></div>

                    <div class="flex flex-col pt-4 border-t border-gray-700">
                        <label for="eric-input" class="text-gray-400 text-sm mb-2">ERIC ID</label>
                        <input type="text" id="eric-input" placeholder="ERIC-11111, ERIC_11111, and 11111 are all acceptable." 
                               class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200 text-center">
                    </div>

                    <button id="eric-search-button" disabled 
                                 class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-bold shadow-lg 
                                       hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 
                                       focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 
                                       disabled:opacity-50 disabled:cursor-not-allowed"> 
                        Search by ERIC ID
                    </button>
                </div>

                <!-- 3. Parcel Search Section -->
                <div class="space-y-4 border-b border-gray-700 pb-8">
                    <h2 class="text-xl font-bold text-purple-400 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        Parcel Search 
                        <div class="relative group ml-2 cursor-help">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-300 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 text-white text-xs font-normal rounded-lg shadow-xl border border-gray-600 hidden group-hover:block z-50 text-center leading-relaxed">
                                Each Property Appraiser search below will open a new tab with a shareable link at the top.
                            </div>
                        </div>
                    </h2>

                    <div class="space-y-6">
                        <div class="p-4 bg-gray-700/50 rounded-lg space-y-3">
                            <h3 class="text-lg font-semibold text-purple-300">Search by Folio Number:</h3>
                            <input type="text" id="folio-input" placeholder="e.g., 01-1028-147-1010 (dashes optional)" 
                                   class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200 text-center w-full">
                            <button id="folio-search-button" disabled 
                                    class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-bold shadow-md 
                                           hover:bg-purple-700 transition duration-200 disabled:opacity-50"> 
                                Search Folio via Property Appraiser
                            </button>
                            <button id="folio-ecm-search-button" disabled 
                                    class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-bold shadow-md 
                                           hover:bg-purple-700 transition duration-200 disabled:opacity-50"> 
                                Search Folio via ECM/CARA
                            </button>
                        </div>
                        <div class="p-4 bg-gray-700/50 rounded-lg space-y-3">
                            <h3 class="text-lg font-semibold text-purple-300">Search by Address:</h3>
                            <input type="text" id="address-input" placeholder="e.g., 2735 NW 7TH ST" 
                                   class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200 text-center w-full">
                            <button id="address-search-button" disabled 
                                    class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-bold shadow-md 
                                           hover:bg-purple-700 transition duration-200 disabled:opacity-50"> 
                                Search Address via Property Appraiser
                            </button>
                            <button id="env-search-button" disabled 
                                    class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-bold shadow-md 
                                           hover:bg-purple-700 transition duration-200 disabled:opacity-50 flex items-center justify-center gap-2"> 
                                <span>Search Environmental Considerations Map</span>
                                <div class="inline-flex items-center justify-center w-5 h-5 border border-white rounded-full text-[10px] font-serif italic cursor-help shrink-0" 
                                     title="DERM EC Map will sometimes say error. Click ok on the error and then click search at the top left of the page next to the address.">
                                    i
                                </div>
                            </button>
                            <button id="earth-search-button" disabled 
                                    class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-bold shadow-md 
                                           hover:bg-purple-700 transition duration-200 disabled:opacity-50"> 
                                Search Google Earth
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 4. FDEP STCM GIS Layer -->
                <div class="space-y-4">
                    <h2 class="text-xl font-bold text-red-400 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243m10.606 0a2 2 0 110-2 2 2 0 010 2zm-8 2a2 2 0 110-2 2 2 0 010 2z" />
                        </svg>
                        Search FDEP STCM GIS Layer
                        <div class="relative group ml-2 cursor-help">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-300 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 text-white text-xs font-normal rounded-lg shadow-xl border border-gray-600 hidden group-hover:block z-50 text-center leading-relaxed">
                                Use this option to find a facility by using FDEP Map Direct at https://ca.dep.state.fl.us/mapdirect/ (note: This GIS Point is usually placed at the most current UST locations per FDEP STCM GPS coordinates)
                            </div>
                        </div>
                    </h2>
                    <input type="tel" id="map-facid-input" inputmode="numeric" placeholder="Enter FACID, e.g., 138505326 or 8505326" 
                           class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200 text-center w-full">
                    <button id="map-search-button" disabled 
                                 class="w-full bg-red-600 text-white py-3 px-6 rounded-lg font-bold shadow-lg 
                                       hover:bg-red-700 transition duration-200 disabled:opacity-50"> 
                        Search STCM GIS Layer
                    </button>
                    <div class="flex justify-center pt-2">
                        <div class="relative group cursor-help">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 text-white text-xs font-normal rounded-lg shadow-xl border border-gray-600 hidden group-hover:block z-50 text-center leading-relaxed">
                                If something is broken, email ramirez.jorge@live.com
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Browser View -->
    <div id="browser-view" class="hidden fixed inset-0 z-10 bg-gray-900">
        <iframe id="results-iframe" src="about:blank" class="w-full h-full border-none relative z-0" loading="lazy"></iframe>
        
        <div class="fixed top-4 left-4 right-4 flex flex-col space-y-3 z-20">
            <!-- Main Controls Row -->
            <div class="flex flex-wrap items-center gap-2">
                <button id="new-search-button" 
                        class="bg-yellow-400 text-gray-900 py-2 px-3 rounded-lg font-bold shadow-xl hover:bg-yellow-500 transition duration-200 text-xs whitespace-nowrap"> 
                    ‚Üê New Search 
                </button>
                <button id="copy-link-button"
                        class="bg-orange-500 text-white py-2 px-3 rounded-lg font-bold shadow-xl hover:bg-orange-600 transition duration-200 text-xs whitespace-nowrap hidden">
                    Copy Link
                </button>
                
                <!-- Shortened Green Buttons Container (Nexus/FACID) -->
                <div id="browser-facid-container" class="flex flex-wrap items-center gap-2"></div>

                <div id="folio-transfer-controls" class="flex items-center space-x-2 bg-gray-700 p-2 rounded-xl shadow-xl hidden">
                    <input type="text" id="folio-transfer-input" placeholder="Paste Folio..." 
                           class="bg-gray-800 text-white py-1.5 px-3 rounded-lg text-xs focus:outline-none w-32 sm:w-40" />
                    <button id="transfer-folio-button" disabled 
                            class="bg-purple-600 text-white py-1.5 px-3 rounded-lg font-bold text-xs hover:bg-purple-700 disabled:opacity-50"> 
                        Folio
                    </button>
                </div>
                <div id="address-transfer-controls" class="flex items-center space-x-2 bg-gray-700 p-2 rounded-xl shadow-xl hidden">
                    <input type="text" id="address-transfer-input" placeholder="Paste address..." 
                           class="bg-gray-800 text-white py-1.5 px-3 rounded-lg text-xs focus:outline-none w-32 sm:w-40" />
                    <button id="transfer-address-button" disabled 
                            class="bg-purple-600 text-white py-1.5 px-3 rounded-lg font-bold text-xs hover:bg-purple-700 disabled:opacity-50"> 
                        Address
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // STRICT MAPPING based on user-provided pairs.
        const utMappingData = "2:8503568,5:8505613,6:8505904,7:9102215,13:8629128,14:8628786,15:8628723,18:8503876,21:8505352,24:8628851,26:8506537,32:8506213,33:8506214,38:8504621,39:8504572,43:8506217,47:8629143,48:8506285,50:8622287,55:8505000,58:8506016,62:8504595,69:8505236,73:8732338,78:8504301,79:8504302,82:8841450,86:8943664,88:8505635,89:8505557,91:8944349,101:8503922,104:8503745,105:8736063,106:8503828,107:8503831,109:8504873,115:8505115,118:8504802,121:8504806,122:8504700,123:8504795,126:8504801,129:8505106,130:8505104,131:8505567,132:8505493,135:8503546,136:8506133,137:8506451,138:8504763,142:8520517,144:8520525,148:8504999,153:8506412,154:8504874,155:8504871,157:8504870,160:9063930,161:8505888,163:9100516,165:8505817,166:8503663,172:8504934,178:9101177,182:9046243,193:8503964,194:8735502,197:8503958,199:8505592,200:9200707,202:8735503,205:8842154,206:9202010,207:8505403,214:8506135,215:8838705,218:8504149,221:8504400,222:8504332,224:8504398,225:8622180,226:8503931,227:8506045,229:8506232,236:8504349,237:8505078,238:8505889,240:8505979,241:9101660,245:8504354,247:9063962,250:8504689,251:8841207,253:8504583,257:8945491,260:8628763,261:8504792,263:8505254,264:8505192,265:8505857,266:8505601,267:8504571,269:8506422,272:8504793,276:9202007,277:8628855,278:8622097,280:8504717,283:8522028,287:8505163,288:8628802,294:9301081,296:8505413,298:8736595,300:8504345,308:8505123,313:8506206,317:8506033,327:8506168,330:8503560,331:8503536,333:8838676,338:8503759,339:8503843,340:8505019,342:8942556,347:8504944,348:8504942,353:8505941,354:9046216,359:8506372,365:8504877,373:8506470,375:8732260,378:8506384,379:8504093,383:8505201,389:8504922,410:8503565,414:9046978,417:8505953,427:8733359,428:8622359,430:8504390,431:8503643,433:8505875,434:8504363,435:8505801,437:8505412,439:8504677,440:8504984,442:8506266,444:8506486,447:8504359,452:8504646,457:8506468,459:8505431,460:8504937,464:8506019,466:8504650,470:8505532,472:8504718,475:8504644,476:8505548,478:8506022,480:8503541,484:8506082,487:8506081,490:8504195,491:8505609,493:8504229,495:8503625,498:8838492,499:8505617,500:8504781,501:8505664,502:8503552,503:8503612,505:8503729,506:8506210,508:8504161,510:8504189,513:8504196,515:8505470,518:8622123,520:8735575,521:8840517,522:8506128,524:8842153,525:8506084,526:8622109,528:8841817,529:8944456,531:8520524,533:8505454,536:8841130,540:8505647,543:8505662,544:8506489,548:8504292,550:8503940,551:8504238,557:8505326,558:8504285,560:8505974,561:8503836,563:8504469,564:8504147,565:8522035,566:8506240,568:8503840,569:8503772,570:8503847,571:8506140,572:8505203,573:8504103,574:8503845,576:8503830,580:8505315,583:8505864,584:8506282,585:8503841,588:8504579,589:8503916,590:8504780,592:8504391,594:8505142,595:8505252,597:8505261,598:8503838,600:8504228,601:8503829,602:8522041,606:8506483,610:8504519,611:8504527,612:8505202,616:8506284,617:8506129,618:8521972,622:8504651,626:8505405,628:8505534,630:8504036,636:8504524,644:8505110,648:8504396,650:8504531,653:8622102,655:8504526,659:9046693,667:8505209,668:8505536,672:8504744,673:8506324,676:8505389,679:8505535,684:8504472,685:8506091,688:8505556,689:8504472,690:8505985,696:8506145,699:8504377,700:8505992,701:8505998,702:8505994,703:8622132,704:8505993,708:8505551,709:8505853,710:8505465,711:8505999,713:8504815,715:8504221,717:8503878,718:8622473,719:8505997,720:8504276,721:8504023,722:8504576,723:8503995,725:8504206,727:8838054,728:8504209,730:8504022,731:8506144,732:8629859,733:8504254,734:8504205,735:8504204,736:8504207,740:8504208,744:8622385,756:8629056,762:9101121,774:8505199,777:9102588,778:8630152,781:8504639,784:8505621,785:8504188,786:8505324,787:9045714,810:8505672,822:8505042,824:8504642,828:8505872,833:8503822,841:8505446,842:8838960,844:8841203,847:8505439,850:8504347,851:8520522,853:8503724,855:8505450,861:8520519,864:8505606,868:8520518,874:8841437,876:8838493,877:8504037,880:8944551,884:8504287,887:8504603,889:8622160,891:8505893,895:8629215,897:8506004,901:8505086,905:8732747,909:8504326,913:8504832,914:8504041,915:8839586,921:8628662,923:8628942,926:8505269,929:8841862,930:9046911,931:8505114,937:8505119,938:8506009,940:8504692,941:8504242,942:8505347,947:8506532,949:9045884,952:9202172,960:8506357,961:8504878,962:8506358,964:8506356,965:8506352,968:8506355,974:8504440,976:8505074,977:8503834,981:8503825,982:8504496,991:8506241,996:8505684,997:9815306,999:8628965,1006:8506094,1014:8503538,1017:8522012,1018:8506415,1019:8622168,1026:8505459,1027:8735287,1029:9101618,1031:8732717,1032:8505112,1035:8504770,1036:8622186,1044:8839402,1050:8505918,1051:8622162,1053:8622096,1056:8622397,1058:9103408,1064:9201193,1069:8733359,1071:8842457,1078:8504928,1079:8503927,1082:9063932,1084:8505587,1091:8505306,1092:8944028,1093:9200331,1094:8838442,1100:8841204,1101:9046132,1107:9045888,1109:8503698,1110:8837420,1111:8505437,1114:8506278,1118:8505729,1119:8942809,1127:8504100,1129:8628652,1131:8505458,1136:8506378,1140:8840812,1144:8942667,1146:8504858,1150:8504834,1155:8942557,1156:8943848,1160:8505868,1162:8521976,1166:8521974,1167:8504385,1168:8522062,1174:8504082,1175:8522010,1180:8628974,1181:8504478,1182:8945345,1185:8506379,1187:9202306,1189:8629010,1193:9046086,1194:8505607,1195:8505036,1198:8504110,1200:9601673,1201:8506281,1202:9102401,1207:8504724,1209:8629114,1220:8942809,1221:8506013,1222:8503951,1223:8504747,1225:9046612,1228:8504027,1230:9063893,1238:8943161,1240:8504336,1242:8503638,1244:8942704,1246:8840195,1250:8628672,1251:8942654,1255:9046568,1259:8942558,1260:9046634,1262:9101678,1266:8945303,1276:8731847,1280:8504152,1282:8506476,1297:8841418,1300:8628897,1301:8944027,1306:8629058,1308:9101571,1314:8504311,1342:8944781,1344:8944556,1347:8628853,1354:8628726,1372:9100557,1389:8504895,1394:8628905,1398:8522007,1407:8622312,1408:9200473,1427:8734484,1438:8629197,1452:9101188,1462:8622217,1464:9100032,1474:9063842,1475:8629763,1476:8838262,1478:8841567,1484:8944497,1497:9100054,1501:8622155,1504:9200817,1508:8503636,1518:9100579,1533:8505491,1534:8629085,1536:8622158,1562:8504309,1567:8732567,1578:8628470,1592:9102396,1595:8622188,1601:8735404,1608:8622167,1615:9046843,1623:8840842,1626:8506215,1633:8504620,1637:8838258,1640:8622163,1646:8622122,1655:9102969,1659:8628952,1677:8629115,1678:8628783,1684:8629109,1691:8628848,1694:8840811,1702:8839059,1713:8942698,1714:8505372,1718:8629011,1724:8732754,1734:8943621,1741:8942923,1742:8629370,1750:9045776,1754:9400595,1755:8622184,1764:8732521,1771:9201196,1773:9202163,1777:8842244,1782:9101677,1784:9502690,1789:9601345,1798:9047160,1804:8505159,1805:8944797,1816:9101510,1817:9201448,1828:9202396,1830:9201699,1833:8504921,1846:8942555,1848:8841192,1854:8732522,1862:8504319,1866:9103387,1871:8626150,1884:8506134,1889:8736532,1899:8503633,1900:8942947,1954:8629083,1955:8505344,1959:8622318,1971:8622157,1976:8506267,1983:8622187,1989:9801298,1992:8628926,1999:9101580,2003:9100281,2006:9601524,2010:8505818,2011:8732196,2012:8629184,2019:9813592,2022:8837735,2029:9045874,2037:8622149,2044:8505644,2054:9700732,2083:8629081,2090:8521991,2091:8840684,2101:9047223,2112:8838306,2113:9101874,2117:8942807,2123:8504756,2131:8732280,2134:9045977,2136:9200863,2141:8945123,2154:8945106,2165:8841986,2170:8837995,2174:8521998,2189:8628948,2191:8839867,2199:9401072,2204:8839861,2205:9201892,2208:9202228,2215:8945005,2273:9101320,2275:9701342,2287:8629060,2291:9700259,2310:8504606,2316:9045940,2351:8841042,2354:8842260,2355:8841022,2405:8841043,2410:8944682,2412:9101584,2414:8522020,2419:8839165,2442:9063884,2448:8945065,2450:9101497,2454:8841212,2457:8503535,2470:9101371,2476:8628849,2480:8628711,2538:9801378,2547:8839870,2555:8522022,2558:8736437,2561:8731801,2563:8506344,2565:8522051,2571:8628663,2574:9806894,2575:8622089,2577:8622088,2578:8731878,2585:8628904,2588:8505540,2602:8522025,2603:8942772,2608:8629050,2612:8629420,2613:8522044,2645:8944866,2649:8945114,2664:8628872,2678:8629094,2688:9401227,2689:9201879,2694:8628963,2695:8629195,2713:8732760,2714:8629104,2750:8522037,2766:9103515,2784:9201891,2791:8944189,2793:9101390,2798:9103356,2799:8842046,2815:9045801,2817:9103354,2824:9046231,2827:8842345,2830:9501666,2832:9100232,2833:9046914,2837:9102744,2842:9200080,2846:8842393,2850:8942880,2874:8944281,2897:8942978,2929:8943500,2934:8943308,2955:8943260,2969:8943270,2983:9501682,2985:8942996,2986:8944857,2996:8943216,2999:8731931,3016:8943707,3055:8943220,3064:8943226,3065:8733374,3067:8943230,3074:8943236,3079:8622111,3087:8943360,3096:8943349,3130:9046852,3149:8943327,3153:9600896,3156:8942702,3169:9102485,3199:9046168,3206:9045945,3220:8945537,3223:8505687,3224:9100007,3228:9101381,3262:9501863,3268:9300563,3272:9100154,3277:9101092,3304:8943215,3307:9046225,3308:9103194,3318:8842290,3326:9046210,3340:9200078,3343:9100648,3349:8943737,3353:9202307,3409:8945293,3410:9101612,3455:8629159,3490:9501656,3494:8943501,3514:9101533,3529:9101133,3530:9101920,3534:9401253,3535:8622184,3536:9807695,3538:9200291,3542:9400010,3548:9103362,3582:9102433,3584:8504453,3585:9807366,3586:9602075,3588:9200292,3589:9601308,3591:9103364,3592:8505401,3601:9203113,3607:9202150,3608:9103614,3611:9401906,3738:8839959,3768:8629041,3772:9101186,3786:8733293,3817:8944167,3879:9501539,3882:9202115,3886:9400366,3900:9201166,3904:9102841,3919:9201684,3929:9102677,3930:9202188,3965:9701165,3970:9102133,3991:9202299,4028:9201197,4032:9202182,4038:9401557,4048:9202156,4050:9401093,4052:9200146,4103:9201621,4124:9501600,4147:9201991,4161:9201754,4165:9501701,4169:9202233,4172:9201455,4186:9201305,4187:9201306,4188:9202435,4221:9201747,4230:9815197,4251:9501678,4254:9602241,4284:9501651,4285:9804503,4323:9401476,4324:9501890,4345:9300476,4360:9500561,4361:9700438,4374:9401954,4389:9401688,4423:9201888,4452:9501526,4462:9401897,4498:9501650,5011:9501764,5017:9819168,5043:9807118,5051:9401079,5228:9601054,5234:9701269,5248:9602350,5234:9701269,5248:9602350,5261:9700448,5271:9700100,5274:9800254,5275:8521996,5317:9601928,5336:9602331,5358:9803462,5371:9801253,5373:9700665,5408:9800032,5416:9806124,5419:9805136,5430:9701268,5443:9813745,5462:9800384,5476:9803125,5553:9804985,5593:9600889,5613:9812342,5618:9800896,5620:9800967,5683:9401158,5739:9801197,5815:9601310,5885:9803656,5894:9801903,5910:9601316,5969:9803788,5980:9802579,6098:9804937,6109:9804881,6149:9804384,6183:9804890,6188:9813858,6189:9804353,6253:9806893,6286:9805056,6294:9806179,6302:9806129,6305:9806556,6306:9805141,6379:9804241,6415:9806839,6506:9807670,6508:9807077,6518:9807174,6524:9807233,6550:9807725,6640:9809173,6707:9808898,6793:9810148,6795:9810194,6813:9810555,6820:9810595,6886:9811464,6980:9813651,7030:9813860,7102:9814016,7114:9501060,7150:9814104,7164:9814269,7233:9818109,7274:9814969,7301:9818712,7326:9815521,7427:9816483,7510:9818211,8100:9818069,8121:9818583,8130:9818989,8141:9819162,8184:9819589,8185:9819955,8188:9819996,8192:9820047,8211:9820370";

        const utMapping = {};
        utMappingData.split(',').forEach(entry => {
            const [wg, dep] = entry.split(':');
            if (!utMapping[wg]) utMapping[wg] = [];
            if (!utMapping[wg].includes(dep)) utMapping[wg].push(dep);
        });

        // DOM Elements
        const searchFormView = document.getElementById('search-form-view');
        const browserView = document.getElementById('browser-view');
        const resultsIframe = document.getElementById('results-iframe');
        const newSearchButton = document.getElementById('new-search-button');
        const copyLinkButton = document.getElementById('copy-link-button'); 
        
        const folioTransferControls = document.getElementById('folio-transfer-controls');
        const folioTransferInput = document.getElementById('folio-transfer-input');
        const transferFolioButton = document.getElementById('transfer-folio-button'); 
        
        const addressTransferControls = document.getElementById('address-transfer-controls');
        const addressTransferInput = document.getElementById('address-transfer-input');
        const transferAddressButton = document.getElementById('transfer-address-button');

        const workgroupSelect = document.getElementById('workgroup');
        const caseNumberInput = document.getElementById('case-number');
        const caseSearchButton = document.getElementById('case-search-button');
        const liveFacidContainer = document.getElementById('live-facid-container');
        const browserFacidContainer = document.getElementById('browser-facid-container');
        const facidToWgContainer = document.getElementById('facid-to-wg-container');

        const facidInput = document.getElementById('facid-input');
        const facidSearchButton = document.getElementById('facid-search-button');
        const ericInput = document.getElementById('eric-input');
        const ericSearchButton = document.getElementById('eric-search-button');
        const folioInput = document.getElementById('folio-input');
        const folioSearchButton = document.getElementById('folio-search-button');
        const folioEcmSearchButton = document.getElementById('folio-ecm-search-button');
        const addressInput = document.getElementById('address-input');
        const addressSearchButton = document.getElementById('address-search-button');
        const envSearchButton = document.getElementById('env-search-button');
        const earthSearchButton = document.getElementById('earth-search-button');
        const mapFacidInput = document.getElementById('map-facid-input');
        const mapSearchButton = document.getElementById('map-search-button');

        // Base URLs
        const caseBaseURL = "https://ecmrer.miamidade.gov/document-search?page=1&limit=25&sortOrder=date_desc&searchTerm=&facilityName=&folio=&documentType=&startDate=&endDate=&houseNumber=&streetDirection=&streetName=&streetType=&zipCode=&description=&caseNumber=PLACEHOLDER";
        const ecmFolioBaseURL = "https://ecmrer.miamidade.gov/document-search?page=1&limit=100&sortOrder=date_desc&searchTerm=&facilityName=&caseNumber=&folio=@@@&documentType=&startDate=&endDate=&houseNumber=&streetDirection=&streetName=&streetType=&zipCode=&description=";
        const facidBaseURL = "https://prodenv.dep.state.fl.us/DepNexus/public/electronic-documents/@/facility!search";
        const ericBaseURL = "https://prodenv.dep.state.fl.us/DepNexus/public/electronic-documents/ERIC_@/facility!search";
        const folioBaseURL = "https://www.miamidade.gov/Apps/PA/propertysearch/#/?folio=@";
        const addressBaseURL = "https://apps.miamidadepa.gov/PropertySearch/#/?address=@";
        const envBaseURL = "https://gisweb.miamidade.gov/environmentalconsiderations/?searchtype=address&paramvalue=@";
        const earthBaseURL = "https://earth.google.com/web/search/@/";
        const mapBaseURL = "https://ca.dep.state.fl.us/mapdirect/?focus=stortanks&zoom=query&querytype=stcm&queryvalues=@";

        // Logic Helpers
        const padCaseNumber = (num) => String(num).padStart(5, '0');
        const cleanAddressOrdinals = (addr) => addr.replace(/\b(\d+)(?:ST|ND|RD|TH)\b/gi, '$1');

        // Reverse lookup function
        const findWGsByFacid = (targetFacid) => {
            const results = [];
            for (const [wg, facids] of Object.entries(utMapping)) {
                if (facids.includes(targetFacid)) {
                    results.push(wg);
                }
            }
            return results;
        };

        const updateFacidButtons = () => {
            const group = workgroupSelect.value;
            const number = caseNumberInput.value.trim();
            
            liveFacidContainer.innerHTML = '';
            browserFacidContainer.innerHTML = '';

            if (group === 'UT' && number !== '') {
                const deps = utMapping[String(number)];
                if (deps && deps.length > 0) {
                    const render = (container, isBrowserView = false) => {
                        const wrapper = document.createElement('div');
                        // Browser view uses a row layout for buttons
                        wrapper.className = isBrowserView ? 'flex items-center gap-2 facid-entry' : 'flex flex-col space-y-4 w-full facid-entry';
                        
                        deps.forEach(id => {
                            const btn = document.createElement('button');
                            if (isBrowserView) {
                                // Shortened, smaller button for browser view
                                btn.className = 'bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg font-bold shadow-lg transition duration-200 text-xs whitespace-nowrap';
                                btn.textContent = `FACID: ${id}`;
                            } else {
                                // Original larger button for form view
                                btn.className = 'w-full bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-bold shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200';
                                btn.textContent = `Search Nexus Portal for FDEP Facility ${id}`;
                            }
                            
                            btn.onclick = () => {
                                const url = facidBaseURL.replace('@', id);
                                resultsIframe.src = url;
                                searchFormView.classList.add('hidden');
                                browserView.classList.remove('hidden');
                                copyLinkButton.dataset.url = url; 
                                copyLinkButton.classList.remove('hidden');
                                addressTransferControls.classList.remove('hidden');
                                folioTransferControls.classList.add('hidden');
                            };
                            wrapper.appendChild(btn);
                        });

                        if (!isBrowserView && deps.length > 1) {
                            const infoIcon = document.createElement('div');
                            infoIcon.className = 'flex items-center justify-center space-x-2 text-green-300 text-sm italic';
                            infoIcon.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Work Group is associated with multiple FDEP Facility IDs.</span>
                            `;
                            wrapper.appendChild(infoIcon);
                        }
                        container.appendChild(wrapper);
                    };
                    render(liveFacidContainer, false);
                    render(browserFacidContainer, true);
                }
            }
        };

        const updateFacidToWgLookup = () => {
            let id = facidInput.value.replace(/[^0-9]/g, '');
            facidToWgContainer.innerHTML = '';

            if (id.length === 7 || id.length === 9) {
                const extractedFacid = id.length === 9 ? id.substring(2) : id;
                const wgNums = findWGsByFacid(extractedFacid);

                if (wgNums.length > 0) {
                    wgNums.forEach(wgNum => {
                        const btn = document.createElement('button');
                        btn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-bold shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 facid-entry';
                        btn.textContent = `Search ECM/CARA for UT-${wgNum}`;
                        btn.onclick = () => {
                            const formattedCase = `UT-${padCaseNumber(wgNum)}`;
                            const url = caseBaseURL.replace('PLACEHOLDER', formattedCase);
                            resultsIframe.src = url;
                            searchFormView.classList.add('hidden');
                            browserView.classList.remove('hidden');
                            copyLinkButton.dataset.url = url; 
                            copyLinkButton.classList.remove('hidden');
                            folioTransferControls.classList.remove('hidden');
                            addressTransferControls.classList.add('hidden');
                        };
                        facidToWgContainer.appendChild(btn);
                    });
                }
            }
        };

        // Listeners
        caseNumberInput.addEventListener('input', () => {
            if (caseNumberInput.value.length > 5) caseNumberInput.value = caseNumberInput.value.slice(0, 5);
            caseSearchButton.disabled = caseNumberInput.value.length === 0;
            updateFacidButtons();
        });
        workgroupSelect.addEventListener('change', updateFacidButtons);

        facidInput.addEventListener('input', () => {
            facidInput.value = facidInput.value.replace(/[^0-9]/g, '');
            facidSearchButton.disabled = !(facidInput.value.length === 7 || facidInput.value.length === 9);
            updateFacidToWgLookup();
        });
        ericInput.addEventListener('input', () => {
            ericSearchButton.disabled = ericInput.value.replace(/\D/g, '').length === 0;
        });
        folioInput.addEventListener('input', () => {
            const hasCorrectDigits = folioInput.value.replace(/[^0-9]/g, '').length === 13;
            folioSearchButton.disabled = !hasCorrectDigits;
            folioEcmSearchButton.disabled = !hasCorrectDigits;
        });
        addressInput.addEventListener('input', () => {
            const hasText = addressInput.value.trim().length > 0;
            addressSearchButton.disabled = !hasText;
            envSearchButton.disabled = !hasText;
            earthSearchButton.disabled = !hasText;
        });
        mapFacidInput.addEventListener('input', () => {
            mapFacidInput.value = mapFacidInput.value.replace(/[^0-9]/g, '');
            mapSearchButton.disabled = !(mapFacidInput.value.length === 7 || mapFacidInput.value.length === 9);
        });
        folioTransferInput.addEventListener('input', () => {
            transferFolioButton.disabled = folioTransferInput.value.replace(/[^0-9]/g, '').length !== 13;
        });
        addressTransferInput.addEventListener('input', () => {
            transferAddressButton.disabled = addressTransferInput.value.trim().length === 0;
        });

        // Handlers
        caseSearchButton.addEventListener('click', () => {
            const url = caseBaseURL.replace('PLACEHOLDER', `${workgroupSelect.value}-${padCaseNumber(caseNumberInput.value)}`);
            resultsIframe.src = url;
            searchFormView.classList.add('hidden');
            browserView.classList.remove('hidden');
            copyLinkButton.dataset.url = url; 
            copyLinkButton.classList.remove('hidden');
            folioTransferControls.classList.remove('hidden');
            addressTransferControls.classList.add('hidden');
        });

        facidSearchButton.addEventListener('click', () => {
            let id = facidInput.value;
            if (id.length === 9) id = id.substring(2);
            const url = facidBaseURL.replace('@', id);
            resultsIframe.src = url;
            searchFormView.classList.add('hidden');
            browserView.classList.remove('hidden');
            copyLinkButton.dataset.url = url;
            copyLinkButton.classList.remove('hidden');
            addressTransferControls.classList.remove('hidden');
            folioTransferControls.classList.add('hidden');
            
            browserFacidContainer.innerHTML = '';
        });

        ericSearchButton.addEventListener('click', () => {
            const url = ericBaseURL.replace('@', ericInput.value.replace(/\D/g, ''));
            resultsIframe.src = url;
            searchFormView.classList.add('hidden');
            browserView.classList.remove('hidden');
            copyLinkButton.dataset.url = url;
            copyLinkButton.classList.remove('hidden');
            
            browserFacidContainer.innerHTML = '';
        });

        folioSearchButton.addEventListener('click', () => {
            window.open(folioBaseURL.replace('@', folioInput.value.replace(/[^0-9]/g, '')), '_blank');
        });

        folioEcmSearchButton.addEventListener('click', () => {
            const cleanFolio = folioInput.value.replace(/[^0-9]/g, '');
            const url = ecmFolioBaseURL.replace('@@@', cleanFolio);
            resultsIframe.src = url;
            searchFormView.classList.add('hidden');
            browserView.classList.remove('hidden');
            copyLinkButton.dataset.url = url; 
            copyLinkButton.classList.remove('hidden');
            folioTransferControls.classList.remove('hidden');
            addressTransferControls.classList.add('hidden');
        });

        addressSearchButton.addEventListener('click', () => {
            window.open(addressBaseURL.replace('@', encodeURIComponent(cleanAddressOrdinals(addressInput.value.trim()))), '_blank');
        });
        envSearchButton.addEventListener('click', () => {
            const cleaned = cleanAddressOrdinals(addressInput.value.trim());
            window.open(envBaseURL.replace('@', encodeURIComponent(cleaned)), '_blank');
        });
        earthSearchButton.addEventListener('click', () => {
            const rawAddress = addressInput.value.trim() + ", Miami-Dade County";
            const plusFormatted = rawAddress.replace(/\s+/g, '+');
            window.open(earthBaseURL.replace('@', plusFormatted), '_blank');
        });
        mapSearchButton.addEventListener('click', () => {
            let id = mapFacidInput.value;
            if (id.length === 9) id = id.substring(2);
            window.open(mapBaseURL.replace('@', id), '_blank');
        });

        transferFolioButton.addEventListener('click', () => {
            window.open(folioBaseURL.replace('@', folioTransferInput.value.replace(/[^0-9]/g, '')), '_blank');
            folioTransferInput.value = '';
            transferFolioButton.disabled = true;
        });
        transferAddressButton.addEventListener('click', () => {
            window.open(addressBaseURL.replace('@', encodeURIComponent(cleanAddressOrdinals(addressTransferInput.value.trim()))), '_blank');
            addressTransferInput.value = '';
            transferAddressButton.disabled = true;
        });

        copyLinkButton.addEventListener('click', () => {
            const url = copyLinkButton.dataset.url;
            if (!url) return;
            const temp = document.createElement('textarea');
            temp.value = url;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            const oldText = copyLinkButton.textContent;
            copyLinkButton.textContent = 'Copied!';
            setTimeout(() => copyLinkButton.textContent = oldText, 2000);
        });

        newSearchButton.addEventListener('click', () => {
            caseNumberInput.value = '';
            facidInput.value = '';
            ericInput.value = ''; 
            folioInput.value = '';
            addressInput.value = '';
            mapFacidInput.value = '';
            caseSearchButton.disabled = facidSearchButton.disabled = ericSearchButton.disabled = folioSearchButton.disabled = folioEcmSearchButton.disabled = addressSearchButton.disabled = envSearchButton.disabled = earthSearchButton.disabled = mapSearchButton.disabled = true;
            liveFacidContainer.innerHTML = '';
            browserFacidContainer.innerHTML = '';
            facidToWgContainer.innerHTML = '';
            resultsIframe.src = 'about:blank';
            browserView.classList.add('hidden');
            searchFormView.classList.remove('hidden');
        });
    </script>
</body>
</html>
