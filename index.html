<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Records Search Portal</title>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Apply Inter font globally and set dark theme defaults */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for inputs */
        input::placeholder {
            color: #9ca3af; /* Gray-400 */
            opacity: 0.8;
        }

        /* Remove arrows/spinners from number inputs */
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4">

    <!-- Search Form View: Vertically and horizontally centered -->
    <div id="search-form-view" class="w-full max-w-xl mx-auto flex flex-col items-center justify-center min-h-screen py-8">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl flex flex-col items-center w-full">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-8 text-yellow-400">
                Public Records Search
            </h1>
            
            <div class="space-y-8 w-full max-w-md">

                <!-- 1. Case Number Search Section (ECM/CARA) -->
                <div class="space-y-4 border-b border-gray-700 pb-8">
                    <h2 class="text-xl font-bold text-blue-400 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-9 0V3h4m-4 2h4m-2 2h2m-6 0v2m0 4v2m0 4v2m4-10h2m0 4h2m0 4h2" />
                        </svg>
                        Search DERM/RER Records

                        <!-- Info Tooltip -->
                        <div class="relative group ml-2 cursor-help">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-300 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 text-white text-xs font-normal rounded-lg shadow-xl border border-gray-600 hidden group-hover:block z-50 text-center leading-relaxed">
                                Use this option to search the DERM/RER Public Records at https://ecmrer.miamidade.gov/
                            </div>
                        </div>
                    </h2>
                    
                    <!-- Workgroup Selector -->
                    <div class="flex flex-col">
                        <label for="workgroup" class="text-gray-400 text-sm mb-2">Work Group </label>
                        <select id="workgroup" class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                            <option value="UT" selected>UT</option>
                            <option value="HWR">HWR</option>
                            <option value="IW5">IW5</option>
                            <option value="IW6">IW6</option>
                        </select>
                    </div>

                    <!-- Case Number Input -->
                    <div class="flex flex-col">
                        <label for="case-number" class="text-gray-400 text-sm mb-2">Work Group Number</label>
                        <input type="number" id="case-number" placeholder="e.g., 557 (no leading zeros)" 
                               class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-center" 
                               oninput="if(this.value.length > 5) this.value=this.value.slice(0,5)">
                    </div>

                    <!-- Search Button -->
                    <button id="case-search-button" disabled 
                                class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-bold shadow-lg 
                                       hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 
                                       focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 
                                       disabled:opacity-50 disabled:cursor-not-allowed"> 
                        Search ECM/CARA
                    </button>
                </div>

                <!-- 2. FDEP Facility ID Search Section (Nexus Portal) -->
                <div class="space-y-4 border-b border-gray-700 pb-8">
                    <h2 class="text-xl font-bold text-green-400 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Search FDEP Information Portal

                        <!-- Info Tooltip (Green) -->
                        <div class="relative group ml-2 cursor-help">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-300 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 text-white text-xs font-normal rounded-lg shadow-xl border border-gray-600 hidden group-hover:block z-50 text-center leading-relaxed">
                                Use this option to search the FDEP Information Portal for an FDEP FACID or for an FDEP ERIC ID at https://prodenv.dep.state.fl.us/DepNexus/
                            </div>
                        </div>
                    </h2>

                    <!-- FACID Input -->
                    <div class="flex flex-col">
                        <label for="facid-input" class="text-gray-400 text-sm mb-2">FDEP Facility ID</label>
                        <input type="tel" id="facid-input" inputmode="numeric" placeholder="Enter FACID, e.g., 138505326 or 8505326" 
                               class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200 text-center">
                    </div>

                    <!-- Search by FACID Button -->
                    <button id="facid-search-button" disabled 
                                class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-bold shadow-lg 
                                       hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 
                                       focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 
                                       disabled:opacity-50 disabled:cursor-not-allowed"> 
                        Search by FACID
                    </button>

                    <!-- ERIC Input (New) -->
                    <div class="flex flex-col pt-4 border-t border-gray-700">
                        <label for="eric-input" class="text-gray-400 text-sm mb-2">ERIC ID</label>
                        <input type="text" id="eric-input" placeholder="ERIC-999, ERIC_999, and 999 are all acceptable." 
                               class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200 text-center">
                    </div>

                    <!-- Search by ERIC Button (New) -->
                    <button id="eric-search-button" disabled 
                                class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-bold shadow-lg 
                                       hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 
                                       focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 
                                       disabled:opacity-50 disabled:cursor-not-allowed"> 
                        Search by ERIC ID
                    </button>
                </div>

                <!-- 3. Property Appraiser Search Section (Folio & Address) -->
                <div class="space-y-4 border-b border-gray-700 pb-8">
                    <h2 class="text-xl font-bold text-purple-400 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        Property Appraiser Search 

                        <!-- Info Tooltip (Purple) -->
                        <div class="relative group ml-2 cursor-help">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-300 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 text-white text-xs font-normal rounded-lg shadow-xl border border-gray-600 hidden group-hover:block z-50 text-center leading-relaxed">
                                Each Property Appraiser search below will open a new tab with a shareable link (unlike the property search application of the Property Appraiser's website).
                            </div>
                        </div>
                    </h2>

                    <div class="space-y-6">
                        <!-- Folio Search Block -->
                        <div class="p-4 bg-gray-700/50 rounded-lg space-y-3">
                            <h3 class="text-lg font-semibold text-purple-300">Search by Folio Number:</h3>
                            <div class="flex flex-col">
                                <input type="text" id="folio-input" placeholder="e.g., 01-1028-147-1010 (dashes optional)" 
                                       class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200 text-center">
                            </div>
                            <button id="folio-search-button" disabled 
                                    class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-bold shadow-md 
                                           hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 
                                           focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 
                                           disabled:opacity-50 disabled:cursor-not-allowed"> 
                                Search Folio
                            </button>
                        </div>

                        <!-- Address Search Block -->
                        <div class="p-4 bg-gray-700/50 rounded-lg space-y-3">
                            <h3 class="text-lg font-semibold text-purple-300">Search by Address:</h3>
                            <div class="flex flex-col">
                                <input type="text" id="address-input" placeholder="e.g., 2735 NW 7TH ST" 
                                       class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200 text-center">
                            </div>
                            <button id="address-search-button" disabled 
                                    class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-bold shadow-md 
                                           hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 
                                           focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 
                                           disabled:opacity-50 disabled:cursor-not-allowed"> 
                                Search Address
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 4. FDEP GIS Facility Search Section (Map Direct) -->
                <div class="space-y-4">
                    <h2 class="text-xl font-bold text-red-400 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243m10.606 0a2 2 0 110-2 2 2 0 010 2zm-8 2a2 2 0 110-2 2 2 0 010 2z" />
                        </svg>
                        Search FDEP STCM GIS Layer

                        <!-- Info Tooltip (Red) -->
                        <div class="relative group ml-2 cursor-help">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-300 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 text-white text-xs font-normal rounded-lg shadow-xl border border-gray-600 hidden group-hover:block z-50 text-center leading-relaxed">
                                Use this option to locate the facility by using FDEP Map Direct at https://ca.dep.state.fl.us/mapdirect/
                            </div>
                        </div>
                    </h2>

                    <!-- FACID Input for Map -->
                    <div class="flex flex-col">
                        <input type="tel" id="map-facid-input" inputmode="numeric" placeholder="Enter FACID, e.g., 138505326 or 8505326" 
                               class="bg-gray-700 text-white py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200 text-center">
                    </div>

                    <!-- Search by FACID Button for Map -->
                    <button id="map-search-button" disabled 
                                class="w-full bg-red-600 text-white py-3 px-6 rounded-lg font-bold shadow-lg 
                                       hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 
                                       focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 
                                       disabled:opacity-50 disabled:cursor-not-allowed"> 
                        Search STCM GIS Layer
                    </button>

                    <!-- Support/Contact Icon -->
                    <div class="flex justify-center pt-2">
                        <div class="relative group cursor-help">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-gray-900 text-white text-xs font-normal rounded-lg shadow-xl border border-gray-600 hidden group-hover:block z-50 text-center leading-relaxed">
                                If something is broken, email ramirez.jorge@live.com
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Browser View (Hidden by default, fixed full screen) -->
    <div id="browser-view" class="hidden fixed inset-0 z-10">
        <iframe id="results-iframe" src="about:blank" class="w-full h-full border-none relative z-0" loading="lazy"></iframe>
        
        <!-- Controls for the browser view -->
        <div class="fixed top-4 left-4 flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 z-20">
            <button id="new-search-button" 
                    class="bg-yellow-400 text-gray-900 py-2 sm:py-3 px-4 sm:px-6 rounded-lg font-bold shadow-xl 
                           hover:bg-yellow-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 
                           focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 z-10 text-sm sm:text-base"> 
                ‚Üê New Search 
            </button>

            <!-- Copy Link Button -->
            <button id="copy-link-button"
                    class="bg-orange-500 text-white py-2 sm:py-3 px-4 sm:px-6 rounded-lg font-bold shadow-xl 
                           hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-400 
                           focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200 z-10 
                           text-sm sm:text-base hidden">
                Copy Page Link
            </button>

            <!-- Folio Transfer Controls (SHOWS AFTER ECM CASE SEARCH) -->
            <div id="folio-transfer-controls" class="flex items-center space-x-2 bg-gray-700 p-2 rounded-xl shadow-xl hidden">
                <input type="text" id="folio-transfer-input" placeholder="Paste Folio from results..." 
                       class="bg-gray-800 text-white py-2 px-3 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 w-40 sm:w-60" />
                <button id="transfer-folio-button" disabled 
                        class="bg-purple-600 text-white py-2 px-3 rounded-lg font-bold text-sm 
                               hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition duration-200"> 
                    Search Folio
                </button>
            </div>
            
            <!-- Address Transfer Controls (SHOWS AFTER FDEP NEXUS SEARCH) -->
            <div id="address-transfer-controls" class="flex items-center space-x-2 bg-gray-700 p-2 rounded-xl shadow-xl hidden">
                <input type="text" id="address-transfer-input" placeholder="Paste address from results" 
                       class="bg-gray-800 text-white py-2 px-3 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 w-40 sm:w-60" />
                <button id="transfer-address-button" disabled 
                        class="bg-purple-600 text-white py-2 px-3 rounded-lg font-bold text-sm 
                               hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition duration-200"> 
                    Search Address
                </button>
            </div>

            <!-- The old generated-url span is now always hidden as its functionality is replaced by the button -->
            <span id="generated-url" class="hidden"></span> 
        </div>
    </div>
    
    <script>
        // === DOM Elements ===
        const searchFormView = document.getElementById('search-form-view');
        const browserView = document.getElementById('browser-view');
        const resultsIframe = document.getElementById('results-iframe');
        const newSearchButton = document.getElementById('new-search-button');
        const generatedUrlSpan = document.getElementById('generated-url'); // Still exists but is always hidden
        const copyLinkButton = document.getElementById('copy-link-button'); 
        
        // Folio Transfer Elements
        const folioTransferControls = document.getElementById('folio-transfer-controls');
        const folioTransferInput = document.getElementById('folio-transfer-input');
        const transferFolioButton = document.getElementById('transfer-folio-button'); 
        
        // Address Transfer Elements
        const addressTransferControls = document.getElementById('address-transfer-controls');
        const addressTransferInput = document.getElementById('address-transfer-input');
        const transferAddressButton = document.getElementById('transfer-address-button');

        // Case Search Elements
        const workgroupSelect = document.getElementById('workgroup');
        const caseNumberInput = document.getElementById('case-number');
        const caseSearchButton = document.getElementById('case-search-button');

        // Nexus FACID Search Elements
        const facidInput = document.getElementById('facid-input');
        const facidSearchButton = document.getElementById('facid-search-button');

        // ERIC Search Elements (New)
        const ericInput = document.getElementById('eric-input');
        const ericSearchButton = document.getElementById('eric-search-button');

        // Folio Search Elements (on main page)
        const folioInput = document.getElementById('folio-input');
        const folioSearchButton = document.getElementById('folio-search-button');
        
        // Address Search Elements (on main page)
        const addressInput = document.getElementById('address-input');
        const addressSearchButton = document.getElementById('address-search-button');

        // Map FACID Search Elements
        const mapFacidInput = document.getElementById('map-facid-input');
        const mapSearchButton = document.getElementById('map-search-button');

        // === Base URLs ===
        const caseBaseURL = "https://ecmrer.miamidade.gov/document-search?page=1&limit=25&sortOrder=date_desc&searchTerm=&facilityName=&folio=&documentType=&startDate=&endDate=&houseNumber=&streetDirection=&streetName=&streetType=&zipCode=&description=&caseNumber=PLACEHOLDER";
        const facidBaseURL = "https://prodenv.dep.state.fl.us/DepNexus/public/electronic-documents/@/facility!search";
        const ericBaseURL = "https://prodenv.dep.state.fl.us/DepNexus/public/electronic-documents/ERIC_@/facility!search";
        const folioBaseURL = "https://www.miamidade.gov/Apps/PA/propertysearch/#/?folio=@";
        const addressBaseURL = "https://apps.miamidadepa.gov/PropertySearch/#/?address=@";
        const mapBaseURL = "https://ca.dep.state.fl.us/mapdirect/?focus=stortanks&zoom=query&querytype=stcm&queryvalues=@";

        // === Utility Functions ===

        const padCaseNumber = (num) => String(num).padStart(5, '0');
        // Updated to allow up to 9 digits
        const cleanFacidInput = (input) => input.value.replace(/[^0-9]/g, '').slice(0, 9);

        const cleanAddressOrdinals = (address) => {
            if (!address) return '';
            // Removes ordinal indicators (st, nd, rd, th) from numbers
            // e.g., "7TH ST" -> "7 ST", "1ST AVE" -> "1 AVE"
            // Uses a case-insensitive regex with a word boundary
            return address.replace(/(\d+)(ST|ND|RD|TH)\b/gi, '$1');
        };

        // Function to show the browser view and manage URL display
        const showBrowserView = (url) => {
            searchFormView.classList.add('hidden');
            browserView.classList.remove('hidden');

            copyLinkButton.dataset.url = url; // Store the URL on the button
            copyLinkButton.classList.remove('hidden'); // Show the copy button
            
            // Ensure the span is always hidden as it's no longer used for display
            generatedUrlSpan.classList.add('hidden'); 
        };

        // Function to open in a new tab
        const openInNewTab = (url) => {
            window.open(url, '_blank');
            // When opening in a new tab, hide the copy button as it's not relevant for the current iframe view
            copyLinkButton.classList.add('hidden'); 
            // Also hide transfer controls as the user is likely navigating away
            folioTransferControls.classList.add('hidden');
            addressTransferControls.classList.add('hidden');
        };

        // === Input Event Listeners for Validation and Cleanup ===

        // 1. Case Number Validation
        caseNumberInput.addEventListener('input', () => {
            if (caseNumberInput.value.length > 5) {
                caseNumberInput.value = caseNumberInput.value.slice(0, 5);
            }
            caseSearchButton.disabled = caseNumberInput.value.length === 0;
        });
        // 2. Nexus FACID Validation (7 or 9 digits required)
        facidInput.addEventListener('input', () => {
            facidInput.value = cleanFacidInput(facidInput);
            // Enable button if length is exactly 7 OR exactly 9
            facidSearchButton.disabled = !(facidInput.value.length === 7 || facidInput.value.length === 9);
        });

        // 2.1 ERIC Validation (Allow text, validate digits exist)
        ericInput.addEventListener('input', () => {
            // Check if there are any digits in the input to enable the button
            const numericPart = ericInput.value.replace(/\D/g, ''); 
            ericSearchButton.disabled = numericPart.length === 0;
        });

        // 3. Folio Validation (13 digits required after removing dashes) - Main Page Input
        folioInput.addEventListener('input', () => {
            const cleanedFolio = folioInput.value.replace(/[^0-9]/g, ''); 
            folioSearchButton.disabled = cleanedFolio.length !== 13;
        });

        // 4. Address Validation - Main Page Input (Enabled if not empty)
        addressInput.addEventListener('input', () => {
            addressSearchButton.disabled = addressInput.value.trim().length === 0;
        });

        // 5. Map FACID Validation (7 or 9 digits required)
        mapFacidInput.addEventListener('input', () => {
            mapFacidInput.value = cleanFacidInput(mapFacidInput);
            // Enable button if length is exactly 7 OR exactly 9
            mapSearchButton.disabled = !(mapFacidInput.value.length === 7 || mapFacidInput.value.length === 9);
        });
        
        // 6. Folio Transfer Input Validation (Browser View)
        folioTransferInput.addEventListener('input', () => {
            const cleanedFolio = folioTransferInput.value.replace(/[^0-9]/g, ''); 
            transferFolioButton.disabled = cleanedFolio.length !== 13;
        });
        
        // 7. Address Transfer Input Validation (Browser View)
        addressTransferInput.addEventListener('input', () => {
            transferAddressButton.disabled = addressTransferInput.value.trim().length === 0;
        });

        // === Search Button Click Handlers ===

        // 1. Case Search Handler (Shows Folio Transfer)
        caseSearchButton.addEventListener('click', () => {
            const workgroup = workgroupSelect.value;
            const caseNumber = caseNumberInput.value;
            const formattedCaseNumber = `${workgroup}-${padCaseNumber(caseNumber)}`; 
            const finalURL = caseBaseURL.replace('PLACEHOLDER', formattedCaseNumber);
            resultsIframe.src = finalURL;
            
            showBrowserView(finalURL); // Now handles showing copy button
            
            // Show Folio controls, Hide Address controls
            folioTransferControls.classList.remove('hidden');
            addressTransferControls.classList.add('hidden');
        });

        // 2. FACID Search Handler (Shows Address Transfer)
        facidSearchButton.addEventListener('click', () => {
            let facid = facidInput.value;
            
            // If 9 digits are entered, ignore the first two (leftmost)
            if (facid.length === 9) {
                facid = facid.substring(2);
            }

            const finalURL = facidBaseURL.replace('@', facid);
            resultsIframe.src = finalURL;
            
            showBrowserView(finalURL); // Now handles showing copy button

            // Show Address controls, Hide Folio controls
            addressTransferControls.classList.remove('hidden');
            folioTransferControls.classList.add('hidden');
        });

        // 2.1 ERIC Search Handler (New)
        ericSearchButton.addEventListener('click', () => {
            // Extract only the numbers from the input (ignores ERIC-, ERIC_, etc.)
            const ericNum = ericInput.value.replace(/\D/g, '');
            const finalURL = ericBaseURL.replace('@', ericNum);
            resultsIframe.src = finalURL;
            
            showBrowserView(finalURL);

            // Show Address controls, Hide Folio controls (Assuming consistent with Nexus behavior)
            addressTransferControls.classList.remove('hidden');
            folioTransferControls.classList.add('hidden');
        });

        // 3. Folio Search Handler (Opens new tab) - Main Page
        folioSearchButton.addEventListener('click', () => {
            const folio = folioInput.value.replace(/[^0-9]/g, '');
            const finalURL = folioBaseURL.replace('@', folio);
            openInNewTab(finalURL);
        });
        
        // 4. Address Search Handler (Opens new tab) - Main Page
        addressSearchButton.addEventListener('click', () => {
            const rawAddress = addressInput.value.trim();
            const cleanedAddress = cleanAddressOrdinals(rawAddress); 
            const encodedAddress = encodeURIComponent(cleanedAddress); 
            const finalURL = addressBaseURL.replace('@', encodedAddress);
            openInNewTab(finalURL);
        });

        // 5. Map Search Handler (Opens new tab)
        mapSearchButton.addEventListener('click', () => {
            let facid = mapFacidInput.value;

            // If 9 digits are entered, ignore the first two (leftmost)
            if (facid.length === 9) {
                facid = facid.substring(2);
            }

            const finalURL = mapBaseURL.replace('@', facid);
            openInNewTab(finalURL);
        });
        
        // 6. Folio Transfer Search Handler - Browser View
        transferFolioButton.addEventListener('click', () => {
            const folio = folioTransferInput.value.replace(/[^0-9]/g, '');
            const finalURL = folioBaseURL.replace('@', folio);
            window.open(finalURL, '_blank');
            folioTransferInput.value = '';
            transferFolioButton.disabled = true;
        });
        
        // 7. Address Transfer Search Handler - Browser View
        transferAddressButton.addEventListener('click', () => {
            const rawAddress = addressTransferInput.value.trim();
            const cleanedAddress = cleanAddressOrdinals(rawAddress); 
            const encodedAddress = encodeURIComponent(cleanedAddress);
            const finalURL = addressBaseURL.replace('@', encodedAddress);
            window.open(finalURL, '_blank');
            addressTransferInput.value = '';
            transferAddressButton.disabled = true;
        });

        // Event Listener for the Copy Link Button
        copyLinkButton.addEventListener('click', () => {
            const urlToCopy = copyLinkButton.dataset.url;
            if (!urlToCopy) return;

            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = urlToCopy;
            tempTextarea.style.position = 'fixed';
            tempTextarea.style.top = '-9999px';
            tempTextarea.style.left = '-9999px';
            
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            
            try {
                document.execCommand('copy');
                copyLinkButton.textContent = 'Copied!';
                setTimeout(() => {
                    copyLinkButton.textContent = 'Copy Page Link';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy link: ', err);
                copyLinkButton.textContent = 'Failed to Copy';
                setTimeout(() => {
                    copyLinkButton.textContent = 'Copy Page Link';
                }, 2000);
            }

            document.body.removeChild(tempTextarea);
        });


        // New Search Button Handler
        newSearchButton.addEventListener('click', () => {
            // Clear all inputs
            caseNumberInput.value = '';
            workgroupSelect.value = 'UT';
            facidInput.value = '';
            ericInput.value = ''; // Clear ERIC input
            folioInput.value = '';
            addressInput.value = '';
            mapFacidInput.value = '';
            folioTransferInput.value = '';
            addressTransferInput.value = ''; 

            // Disable all search buttons
            caseSearchButton.disabled = true;
            facidSearchButton.disabled = true;
            ericSearchButton.disabled = true; // Disable ERIC button
            folioSearchButton.disabled = true;
            addressSearchButton.disabled = true;
            mapSearchButton.disabled = true;
            transferFolioButton.disabled = true;
            transferAddressButton.disabled = true; 

            // Clear and hide the iframe and transfer controls
            resultsIframe.src = 'about:blank';
            folioTransferControls.classList.add('hidden');
            addressTransferControls.classList.add('hidden');

            // Hide and reset the copy link button
            copyLinkButton.classList.add('hidden');
            copyLinkButton.textContent = 'Copy Page Link';
            copyLinkButton.dataset.url = '';

            // Show the search form view
            browserView.classList.add('hidden');
            searchFormView.classList.remove('hidden');
        });
    </script>
</body>
</html>
